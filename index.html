<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wind Forecasts</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        .chart-container {
            margin-bottom: 20px;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
            align-items: center;
        }
        .controls-label {
            font-size: 1rem;
            white-space: nowrap;
        }
        .controls-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .controls label {
            font-size: 1rem;
            cursor: pointer;
            white-space: nowrap;
        }
        .controls input[type="checkbox"] {
            margin-right: 5px;
        }
        .slider-container {
            margin-top: 10px;
            text-align: center;
        }
        .settings-frame {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .forecast-frame {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }
        .dark-mode .error {
            color: #ff6666;
        }
        .dark-mode .settings-frame, .dark-mode .forecast-frame {
            border-color: #333;
        }
    </style>
</head>
<body class="dark-mode">
    <div class="settings-frame">
        <label><input type="checkbox" id="dark-mode-toggle" checked onchange="toggleDarkMode()"> Dark Mode</label>
    </div>

    <div class="forecast-frame">
        <h1>Offshore Wind Forecasts</h1>

        <div id="error-message" class="error"></div>

        <div class="chart-container">
            <div id="chart"></div>
        </div>

        <div class="controls">
            <span class="controls-label">TSO Area:</span>
            <div class="controls-buttons">
                <label><input type="checkbox" id="50hz-checkbox" onchange="updateChart()"> 50Hz</label>
                <label><input type="checkbox" id="tenn-checkbox" onchange="updateChart()"> TenneT</label>
                <label><input type="checkbox" id="total-checkbox" checked onchange="updateChart()"> Total</label>
            </div>
        </div>

        <div class="slider-container">
            <label for="past-data-slider">Amount of past data to show:</label>
            <input type="range" id="past-data-slider" min="1" max="100" step="1" value="20" onchange="updateChart()">
        </div>
    </div>

    <script>
        let isDarkMode = true;

        const chartOptions = {
            chart: {
                type: 'line',
                height: 350,
                toolbar: {
                    show: true
                }
            },
            series: [],
            xaxis: {
                type: 'datetime',
                labels: {
                    style: {
                        colors: isDarkMode ? '#e0e0e0' : '#000'
                    }
                },
                title: {
                    style: {
                        color: isDarkMode ? '#e0e0e0' : '#000'
                    }
                }
            },
            yaxis: {
                title: {
                    text: 'Offshore Wind Power',
                    style: {
                        color: isDarkMode ? '#e0e0e0' : '#000'
                    }
                },
                labels: {
                    style: {
                        colors: isDarkMode ? '#e0e0e0' : '#000'
                    }
                }
            },
            annotations: {
                xaxis: []
            },
            stroke: {
                width: 2
            },
            title: {
                text: 'Wind Forecasts',
                align: 'center',
                style: {
                    color: isDarkMode ? '#e0e0e0' : '#000'
                }
            },
            tooltip: {
                shared: true,
                theme: isDarkMode ? 'dark' : 'light',
                x: {
                    format: 'dd MMM yyyy HH:mm'
                }
            },
            legend: {
                labels: {
                    colors: isDarkMode ? '#e0e0e0' : '#000',
                    useSeriesColors: false
                }
            }
        };

        const chart = new ApexCharts(document.querySelector("#chart"), chartOptions);
        chart.render();

        async function fetchData(variable, file) {
            try {
                const response = await fetch(`data/forecasts/${variable}/${file}`);
                if (!response.ok) {
                    throw new Error(`Failed to load ${variable}`);
                }
                const data = await response.json();
                return data.map(([timestamp, value]) => ({ x: new Date(timestamp), y: value }));
            } catch (error) {
                document.getElementById('error-message').textContent = error.message;
                return null;
            }
        }

        const colorMap = {
            'wind_offshore_50hz': '#1E90FF',
            'wind_offshore_tenn': '#FF6347',
            'wind_offshore': '#2E8B57'
        };

        const aliases = {
            'wind_offshore_tenn': 'TenneT',
            'wind_offshore_50hz': '50Hz',
            'wind_offshore': 'Total'
        };

        function lightenColor(color, percent) {
            const num = parseInt(color.slice(1), 16),
                  amt = Math.round(2.55 * percent),
                  R = (num >> 16) + amt,
                  G = (num >> 8 & 0x00FF) + amt,
                  B = (num & 0x0000FF) + amt;
            return `#${(0x1000000 + (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 + 
                          (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 + 
                          (B < 255 ? (B < 1 ? 0 : B) : 255)).toString(16).slice(1).toUpperCase()}`;
        }

        async function updateChart() {
            document.getElementById('error-message').textContent = '';
            const seriesData = [];
            const annotations = [];

            const pastDataRatio = document.getElementById('past-data-slider').value / 100;

            async function addSeries(variable, pastFile, currentFile, lowerFile, upperFile) {
                const pastFittedData = await fetchData(variable, pastFile);
                const pastActualData = await fetchData(variable, 'XGBoost_prev_actual.json');
                const currentData = await fetchData(variable, currentFile);
                const lowerData = await fetchData(variable, lowerFile);
                const upperData = await fetchData(variable, upperFile);
                const baseColor = colorMap[variable];
                const lighterColor = lightenColor(baseColor, 70);
                const alias = aliases[variable];
            
                if (pastFittedData) {
                    const pastDataToShow = Math.floor(pastFittedData.length * pastDataRatio);
                    seriesData.push({
                        name: `${alias} (Past Fitted)`,
                        data: pastFittedData.slice(-pastDataToShow),
                        color: baseColor,
                    });
                }
                if (pastActualData) {
                    const pastDataToShow = Math.floor(pastActualData.length * pastDataRatio);
                    seriesData.push({
                        name: `${alias} (Past Actual)`,
                        data: pastActualData.slice(-pastDataToShow),
                        color: lighterColor,
                    });
                }
                if (currentData) {
                    seriesData.push({
                        name: `${alias} (Current)`,
                        data: currentData,
                        color: baseColor,
                    });
            
                    if (currentData.length > 0) {
                        annotations.push({
                            x: currentData[0].x.getTime(),
                            borderColor: '#808080',
                            label: {
                                text: 'Last Forecast',
                                style: {
                                    color: '#FFFFFF',
                                    background: '#808080',
                                },
                            },
                        });
                    }
                }
                if (lowerData && upperData && lowerData.length === upperData.length) {
                    // Create a polygon-like dataset by combining lower and upper bounds
                    const forecastPolygon = [
                        ...lowerData.map((point, index) => ({
                            x: point.x,
                            y: point.y, // Lower bound
                        })),
                        ...upperData.map((point, index) => ({
                            x: upperData[upperData.length - 1 - index].x, // Reverse the upper data
                            y: upperData[upperData.length - 1 - index].y, // Upper bound
                        })),
                    ];
            
                    // Add as a "polygon-like" area
                    if (forecastPolygon.length > 0) {
                        seriesData.push({
                            name: `${alias} (Forecast Interval)`,
                            type: 'area', // Ensures area rendering
                            data: forecastPolygon,
                            color: lightenColor(baseColor, 10),
                            fillOpacity: 0.3,
                            showInLegend: true,
                            fill: {
                                type: 'solid', // Ensure solid or gradient fill
                                gradient: {
                                    shade: 'light',
                                    type: 'vertical',
                                    shadeIntensity: 0.4,
                                    gradientToColors: [lightenColor(baseColor, 40),baseColor],
                                    inverseColors: false,
                                    opacityFrom: 0.4,
                                    opacityTo: 0.4,
                                },
                            },
                        });
                    }
                } else {
                    console.error('Lower and upper data are inconsistent or missing!');
                }
            }
            
            
            

            if (document.getElementById('50hz-checkbox').checked) {
                await addSeries('wind_offshore_50hz', 'XGBoost_prev_fitted.json', 'XGBoost_curr_fitted.json', 'XGBoost_curr_lower.json', 'XGBoost_curr_upper.json');
            }

            if (document.getElementById('tenn-checkbox').checked) {
                await addSeries('wind_offshore_tenn', 'XGBoost_prev_fitted.json', 'XGBoost_curr_fitted.json', 'XGBoost_curr_lower.json', 'XGBoost_curr_upper.json');
            }

            if (document.getElementById('total-checkbox').checked) {
                await addSeries('wind_offshore', 'XGBoost_prev_fitted.json', 'XGBoost_curr_fitted.json', 'XGBoost_curr_lower.json', 'XGBoost_curr_upper.json');
            }

            chart.updateOptions({
                series: seriesData,
                annotations: {
                    xaxis: annotations
                },
                tooltip: {
                    theme: isDarkMode ? 'dark' : 'light'
                },
                xaxis: {
                    labels: {
                        style: {
                            colors: isDarkMode ? '#e0e0e0' : '#000'
                        }
                    },
                    title: {
                        style: {
                            color: isDarkMode ? '#e0e0e0' : '#000'
                        }
                    }
                },
                yaxis: {
                    title: {
                        text: 'Offshore Wind Power',
                        style: {
                            color: isDarkMode ? '#e0e0e0' : '#000'
                        }
                    },
                    labels: {
                        style: {
                            colors: isDarkMode ? '#e0e0e0' : '#000'
                        }
                    }
                },
                legend: {
                    labels: {
                        colors: isDarkMode ? '#e0e0e0' : '#000',
                        useSeriesColors: false
                    }
                },
                fill: {
                    type: 'gradient', // Global gradient fill configuration (for polygons and areas)
                    gradient: {
                        shade: 'light',
                        type: 'vertical',
                        shadeIntensity: 0.5,
                        inverseColors: false,
                        opacityFrom: 0.8,
                        opacityTo: 0.5,
                        stops: [40, 100], // Start and end points of the gradient
                    },
                }
            });
        }

        function toggleDarkMode() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            isDarkMode = !isDarkMode;
            updateChart();
        }

        // Initial chart update
        updateChart();
    </script>
</body>
</html>